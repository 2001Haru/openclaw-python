# ä¸ºä»€ä¹ˆ Gateway éœ€è¦ WebSocketï¼Ÿ

> è§£ç­”ï¼šè°ƒç”¨ç³»ç»ŸåŠŸèƒ½ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ HTTPï¼Œå¿…é¡»ç”¨ WebSocketï¼Ÿ

---

## æ ¸å¿ƒé—®é¢˜

**ç–‘é—®**ï¼šGateway çš„ 85 ä¸ªæ–¹æ³•ï¼Œå¤§éƒ¨åˆ†æ˜¯ç³»ç»Ÿç®¡ç†ï¼ˆconfig.getã€channels.status ç­‰ï¼‰ï¼Œè¿™äº›ä¸å°±æ˜¯ç®€å•çš„å‡½æ•°è°ƒç”¨å—ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ WebSocketï¼Ÿç”¨ HTTP REST API ä¸å°±è¡Œäº†ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå› ä¸º Agent çš„ç‰¹æ®Šæ€§ â€”â€” **æµå¼è¾“å‡º** å’Œ **å®æ—¶äº‹ä»¶**ã€‚

---

## HTTP vs WebSocket çš„æœ¬è´¨åŒºåˆ«

### HTTPï¼šå•å‘ã€çŸ­è¿æ¥

```
å®¢æˆ·ç«¯                     æœåŠ¡å™¨
  â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€ è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚     GET /api/config      â”‚
  â”‚                          â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€ å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     { config: {...} }    â”‚
  â”‚                          â”‚
  è¿æ¥å…³é—­                    è¿æ¥å…³é—­
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ã€æ— çŠ¶æ€
- âœ… é€‚åˆè¯·æ±‚-å“åº”æ¨¡å‹
- âŒ æœåŠ¡å™¨æ— æ³•ä¸»åŠ¨æ¨é€
- âŒ æ¯æ¬¡è¯·æ±‚éƒ½è¦å»ºç«‹æ–°è¿æ¥

### WebSocketï¼šåŒå‘ã€æŒä¹…è¿æ¥

```
å®¢æˆ·ç«¯                     æœåŠ¡å™¨
  â”‚                          â”‚
  â”œâ”€â”€â”€â”€ æ¡æ‰‹ï¼ˆHTTPå‡çº§ï¼‰â”€â”€â”€â”€â”€â†’â”‚
  â”‚                          â”‚
  â”‚â†â”€â”€â”€ WebSocket è¿æ¥å»ºç«‹ â”€â”€â”€â”¤
  â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€ æ¶ˆæ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚     { method: "agent" }  â”‚
  â”‚                          â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€ äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     { type: "thinking" } â”‚
  â”‚                          â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€ äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     { type: "text" }     â”‚
  â”‚                          â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€ äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     { type: "done" }     â”‚
  â”‚                          â”‚
  æŒä¹…è¿æ¥ä¿æŒ                æŒä¹…è¿æ¥ä¿æŒ
```

**ç‰¹ç‚¹**ï¼š
- âœ… åŒå‘é€šä¿¡
- âœ… æœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€
- âœ… æŒä¹…è¿æ¥ï¼Œæ— éœ€é‡å¤æ¡æ‰‹
- âœ… ä½å»¶è¿Ÿ

---

## ä¸ºä»€ä¹ˆ Gateway å¿…é¡»ç”¨ WebSocketï¼Ÿ

### åŸå›  1ï¼šAgent çš„æµå¼è¾“å‡º

**Agent å¤„ç†ä¸€ä¸ªæ¶ˆæ¯å¯èƒ½éœ€è¦ 30 ç§’ç”šè‡³æ›´ä¹…**ï¼ŒæœŸé—´ä¼šäº§ç”Ÿå¤§é‡å®æ—¶äº‹ä»¶ï¼š

```python
# Agent è¿è¡Œæ—¶äº§ç”Ÿçš„äº‹ä»¶æµ
async for event in agent_runtime.run_turn(session, message):
    # äº‹ä»¶ 1: å¼€å§‹æ€è€ƒ
    yield AgentEvent(type="thinking", text="æˆ‘éœ€è¦æŸ¥è¯¢å¤©æ°”...")
    
    # äº‹ä»¶ 2: è°ƒç”¨å·¥å…·
    yield AgentEvent(type="tool_use", tool="weather", input={...})
    
    # äº‹ä»¶ 3: å·¥å…·ç»“æœ
    yield AgentEvent(type="tool_result", result="åŒ—äº¬ä»Šå¤©æ™´...")
    
    # äº‹ä»¶ 4-20: æµå¼æ–‡æœ¬è¾“å‡º
    yield AgentEvent(type="text", text="åŒ—")
    yield AgentEvent(type="text", text="äº¬")
    yield AgentEvent(type="text", text="ä»Š")
    yield AgentEvent(type="text", text="å¤©")
    # ... æŒç»­æµå¼è¾“å‡º
    
    # äº‹ä»¶ 21: å®Œæˆ
    yield AgentEvent(type="done")
```

**å¦‚æœç”¨ HTTP**ï¼š
```
âŒ é—®é¢˜ï¼š
- HTTP å“åº”å¿…é¡»ç­‰æ‰€æœ‰å†…å®¹éƒ½ç”Ÿæˆå®Œæ‰èƒ½è¿”å›
- ç”¨æˆ·ç­‰å¾… 30 ç§’çœ‹ä¸åˆ°ä»»ä½•åé¦ˆ
- ä½“éªŒæå·®ï¼ˆå°±åƒ ChatGPT è¦ç­‰ 30 ç§’æ‰ä¸€æ¬¡æ€§æ˜¾ç¤ºå…¨éƒ¨å†…å®¹ï¼‰

âœ… WebSocket æ–¹æ¡ˆï¼š
- æ¯ä¸ªäº‹ä»¶ç«‹å³æ¨é€ç»™å®¢æˆ·ç«¯
- ç”¨æˆ·å®æ—¶çœ‹åˆ° Agent çš„æ€è€ƒè¿‡ç¨‹
- çœ‹åˆ°æ–‡æœ¬é€å­—ç”Ÿæˆï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
- ä½“éªŒæµç•…
```

### åŸå›  2ï¼šåŒå‘å®æ—¶é€šä¿¡

**åœºæ™¯**ï¼šç”¨æˆ·åœ¨ Control UI ä¸­ä¸ Agent å¯¹è¯ï¼ŒåŒæ—¶æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€

```
æ—¶é—´çº¿ï¼š

T=0s  å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šagent({ message: "å¸®æˆ‘åˆ†ææ—¥å¿—" })
      â†“
T=1s  æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š{ type: "thinking", text: "æ­£åœ¨è¯»å–æ—¥å¿—..." }
      â†“
T=3s  æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š{ type: "tool_use", tool: "read_file" }
      â†“
T=5s  æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š{ type: "text", text: "å‘ç°3ä¸ªé”™è¯¯..." }
      â†“
T=10s å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šchat.abort()  â† ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®
      â†“
T=11s æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š{ type: "aborted" }
```

**HTTP æ— æ³•åšåˆ°è¿™ä¸€ç‚¹**ï¼š
- âŒ HTTP è¯·æ±‚å‘å‡ºåï¼Œæ— æ³•åœ¨å“åº”è¿”å›å‰å‘é€æ–°è¯·æ±‚ï¼ˆä¸­æ­¢ï¼‰
- âŒ éœ€è¦å®¢æˆ·ç«¯ä¸æ–­è½®è¯¢ï¼ˆpollingï¼‰ï¼Œæµªè´¹èµ„æº
- âœ… WebSocket å¯ä»¥éšæ—¶åŒå‘å‘é€æ¶ˆæ¯

### åŸå›  3ï¼šäº‹ä»¶å¹¿æ’­

**Gateway çš„èŒè´£ä¹‹ä¸€æ˜¯å¹¿æ’­ç³»ç»Ÿäº‹ä»¶**ï¼š

**âš ï¸ é‡è¦æ¾„æ¸…**ï¼šTelegram Bot **ä¸éœ€è¦** ä¸»åŠ¨è°ƒç”¨ Gatewayï¼Œè€Œæ˜¯ Gateway **è‡ªåŠ¨ç›‘å¬** Agent Runtime çš„äº‹ä»¶ã€‚

```python
# åœºæ™¯ï¼šTelegram ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆæ­£ç¡®çš„æµç¨‹ï¼‰

# ============================================
# Telegram Bot çš„ä»£ç ï¼ˆä¸çŸ¥é“ Gateway å­˜åœ¨ï¼‰
# ============================================
class TelegramChannel:
    async def on_message(self, update):
        user_message = update.message.text
        chat_id = update.message.chat_id
        
        # Bot åªåšä¸¤ä»¶äº‹ï¼š
        # 1. è°ƒç”¨ Agent Runtime
        async for event in agent_runtime.run_turn(session, user_message):
            
            # 2. å‘é€å›å¤åˆ° Telegram
            if event.type == "text":
                await telegram_api.send_message(chat_id, event.text)
            
            # âœ… Bot çš„å·¥ä½œåˆ°æ­¤ç»“æŸ
            # âŒ Bot ä¸éœ€è¦è°ƒç”¨ gateway.broadcast()


# ============================================
# Gateway çš„ä»£ç ï¼ˆè‡ªåŠ¨ç›‘å¬äº‹ä»¶ï¼‰
# ============================================
class GatewayServer:
    def __init__(self, agent_runtime):
        # Gateway åœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œä¸º Agent Runtime çš„è§‚å¯Ÿè€…
        agent_runtime.add_event_listener(self.on_agent_event)
    
    async def on_agent_event(self, event):
        """Agent Runtime æ¯äº§ç”Ÿä¸€ä¸ªäº‹ä»¶ï¼ŒGateway è‡ªåŠ¨æ”¶åˆ°"""
        
        # è‡ªåŠ¨å¹¿æ’­äº‹ä»¶åˆ°æ‰€æœ‰ WebSocket å®¢æˆ·ç«¯
        await self.broadcast_to_all_clients("agent", {
            "type": event.type,
            "text": event.text,
            "sessionKey": event.session_key
        })


# ============================================
# ç»“æœï¼š
# ============================================
# 1. Telegram Bot è°ƒç”¨ Agent â†’ Agent äº§ç”Ÿäº‹ä»¶
# 2. Gateway è‡ªåŠ¨ç›‘å¬åˆ°äº‹ä»¶ â†’ å¹¿æ’­ç»™æ‰€æœ‰ WebSocket å®¢æˆ·ç«¯
# 3. Control UI å®æ—¶çœ‹åˆ°è¿™æ¡å¯¹è¯ï¼ˆå³ä½¿ä¸æ˜¯ Control UI å‘èµ·çš„ï¼‰
# 4. CLI å·¥å…·ä¹Ÿèƒ½ç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶
# 5. iOS App ä¹Ÿèƒ½æ”¶åˆ°æ¨é€

# å…³é”®ç‚¹ï¼š
# - Telegram Bot ä¸çŸ¥é“ Gateway å­˜åœ¨ï¼ˆåªè°ƒç”¨ Agent Runtimeï¼‰
# - Gateway æ˜¯ Agent Runtime çš„è§‚å¯Ÿè€…ï¼ˆè‡ªåŠ¨æ•è·äº‹ä»¶ï¼‰
# - è¿™æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰
```

**æ¶æ„ç¤ºæ„**ï¼š

```
Telegram Bot                Agent Runtime               Gateway
     â”‚                           â”‚                         â”‚
     â”‚                           â”‚    è®¢é˜…äº‹ä»¶              â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                         â”‚
     â”œâ”€â”€â”€â”€ run_turn() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                         â”‚
     â”‚                           â”‚                         â”‚
     â”‚                           â”œâ”€â”€ äº‹ä»¶1: thinking â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚                         â”œâ”€â†’ WebSocket å®¢æˆ·ç«¯
     â”‚                           â”‚                         â”‚
     â”‚â†â”€â”€â”€â”€ event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                           â”‚                         â”‚
     â”œâ”€â”€ send to Telegram â”€â”€â”€â†’   â”‚                         â”‚
     â”‚                           â”‚                         â”‚
     â”‚                           â”œâ”€â”€ äº‹ä»¶2: text â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚                         â”œâ”€â†’ WebSocket å®¢æˆ·ç«¯
     â”‚â†â”€â”€â”€â”€ event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
     â”‚                           â”‚                         â”‚
     â”œâ”€â”€ send to Telegram â”€â”€â”€â†’   â”‚                         â”‚
     â”‚                           â”‚                         â”‚
     
å…³é”®ç†è§£ï¼š
- Telegram Bot ä¸ Agent Runtimeï¼šç›´æ¥å‡½æ•°è°ƒç”¨ï¼ˆåŒè¿›ç¨‹ï¼‰
- Gateway ä¸ Agent Runtimeï¼šè§‚å¯Ÿè€…å…³ç³»ï¼ˆè‡ªåŠ¨ç›‘å¬ï¼‰
- Gateway ä¸å‚ä¸ Bot â†” Agent çš„é€šä¿¡
```

**è¿™æ˜¯ HTTP å®Œå…¨åšä¸åˆ°çš„**ï¼š
- âŒ HTTP æ— æ³•ä¸»åŠ¨æ¨é€
- âŒ å®¢æˆ·ç«¯éœ€è¦æ¯éš” 1 ç§’è½®è¯¢ä¸€æ¬¡ `GET /events`ï¼ˆæå…¶ä½æ•ˆï¼‰
- âœ… WebSocket æœåŠ¡å™¨ç›´æ¥æ¨é€ï¼Œ0 å»¶è¿Ÿ
- âœ… å³ä½¿æ¶ˆæ¯æ¥è‡ª Telegram Botï¼ŒControl UI ä¹Ÿèƒ½å®æ—¶çœ‹åˆ°

---

## æŠ€æœ¯å¯¹æ¯”

### å¦‚æœ Gateway ç”¨ HTTP REST API

```python
# âŒ HTTP æ–¹æ¡ˆçš„é—®é¢˜

# å®¢æˆ·ç«¯ä»£ç 
async def call_agent(message):
    # å‘é€è¯·æ±‚
    response = await http.post("/api/agent", json={"message": message})
    
    # âŒ é—®é¢˜1ï¼šå¿…é¡»ç­‰å¾…å®Œæ•´å“åº”ï¼ˆ30ç§’+ï¼‰
    # âŒ é—®é¢˜2ï¼šæ— æ³•çœ‹åˆ°ä¸­é—´è¿‡ç¨‹
    # âŒ é—®é¢˜3ï¼šæ— æ³•ä¸­é€”å–æ¶ˆ
    # âŒ é—®é¢˜4ï¼šæœåŠ¡å™¨æ— æ³•ä¸»åŠ¨æ¨é€å…¶ä»– channel çš„äº‹ä»¶
    
    result = response.json()
    return result["text"]  # 30 ç§’åæ‰èƒ½æ‹¿åˆ°

# ä¸ºäº†å®æ—¶æ›´æ–°ï¼Œå®¢æˆ·ç«¯éœ€è¦è½®è¯¢
while True:
    events = await http.get("/api/events")  # æ¯ç§’è¯·æ±‚ä¸€æ¬¡
    for event in events:
        display(event)
    await asyncio.sleep(1)  # âŒ æµªè´¹èµ„æºï¼Œä¸”æœ‰å»¶è¿Ÿ
```

### Gateway ä½¿ç”¨ WebSocket

```python
# âœ… WebSocket æ–¹æ¡ˆ

# å®¢æˆ·ç«¯ä»£ç 
async def call_agent(message):
    # å»ºç«‹æŒä¹…è¿æ¥
    ws = await websocket.connect("ws://localhost:8765")
    
    # å‘é€è¯·æ±‚
    await ws.send(json.dumps({
        "method": "agent",
        "params": {"message": message}
    }))
    
    # âœ… å®æ—¶æ¥æ”¶äº‹ä»¶æµ
    async for event in ws:
        data = json.loads(event)
        
        if data["type"] == "thinking":
            display_thinking(data["text"])  # å®æ—¶æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
        
        elif data["type"] == "text":
            display_text(data["text"])  # é€å­—æ˜¾ç¤º
        
        elif data["type"] == "done":
            break
        
        # âœ… åŒæ—¶å¯ä»¥æ¥æ”¶å…¶ä»– channel çš„å¹¿æ’­äº‹ä»¶
        elif data["event"] == "chat":
            display_other_channel_message(data)
    
    # âœ… å¯ä»¥éšæ—¶ä¸­æ­¢
    await ws.send(json.dumps({"method": "chat.abort"}))
```

---

## å®é™…æ¡ˆä¾‹å¯¹æ¯”

### æ¡ˆä¾‹ï¼šè°ƒç”¨ Agent åˆ†æä»£ç 

#### HTTP æ–¹æ¡ˆï¼ˆä¸å®ç”¨ï¼‰

```bash
# å®¢æˆ·ç«¯å‘é€è¯·æ±‚
$ curl -X POST http://localhost:8000/api/agent \
  -d '{"message": "åˆ†æè¿™ä¸ªé¡¹ç›®çš„æ¶æ„"}'

# â³ ç­‰å¾… 45 ç§’...
# ğŸ‘ï¸ å®Œå…¨çœ‹ä¸åˆ°è¿›åº¦
# ğŸ¤” ä¸çŸ¥é“ Agent åœ¨åšä»€ä¹ˆ
# âŒ æ— æ³•ä¸­é€”å–æ¶ˆ

# 45 ç§’åä¸€æ¬¡æ€§è¿”å›
{
  "text": "è¿™ä¸ªé¡¹ç›®é‡‡ç”¨äº†ä¸‰å±‚æ¶æ„ï¼š\n1. Gateway å±‚...\n2. Agent å±‚...\n3. Channel å±‚...",
  "duration": 45000
}
```

#### WebSocket æ–¹æ¡ˆï¼ˆå®ç”¨ï¼‰

```bash
# å®¢æˆ·ç«¯å»ºç«‹è¿æ¥
$ wscat -c ws://localhost:8765

# å‘é€è¯·æ±‚
> {"method": "agent", "params": {"message": "åˆ†æè¿™ä¸ªé¡¹ç›®çš„æ¶æ„"}}

# âœ… å®æ—¶æ¥æ”¶äº‹ä»¶ï¼ˆä½“éªŒæµç•…ï¼‰
< {"type": "thinking", "text": "æˆ‘éœ€è¦è¯»å–é¡¹ç›®ç»“æ„..."}  # T=1s
< {"type": "tool_use", "tool": "list_files"}               # T=2s
< {"type": "tool_result", "files": [...]}                  # T=3s
< {"type": "thinking", "text": "æˆ‘çœ‹åˆ°äº† Gatewayã€Agentã€Channel..."}  # T=5s
< {"type": "text", "text": "è¿™"}  # T=10s
< {"type": "text", "text": "ä¸ª"}  # T=10.1s
< {"type": "text", "text": "é¡¹"}  # T=10.2s
< {"type": "text", "text": "ç›®"}  # T=10.3s
# ... é€å­—è¾“å‡º
< {"type": "done"}  # T=45s

# âœ… ç”¨æˆ·éšæ—¶å¯ä»¥æŒ‰ Ctrl+C æˆ–å‘é€ abort
> {"method": "chat.abort"}
< {"type": "aborted"}
```

---

## Gateway çš„ 85 ä¸ªæ–¹æ³• vs WebSocket

### ç®€å•æ–¹æ³•ï¼ˆå¦‚ config.getï¼‰

**ç–‘é—®**ï¼š`config.get` è¿™ç§ç®€å•æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç”¨ HTTPï¼Ÿ

**ç­”æ¡ˆ**ï¼š
1. **ç»Ÿä¸€æ¥å£**ï¼šGateway æä¾›ä¸€ä¸ª WebSocket ç«¯ç‚¹ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½é€šè¿‡åŒä¸€è¿æ¥
2. **é¿å…æ··åˆåè®®**ï¼šå¦‚æœ agent ç”¨ WebSocketï¼Œconfig ç”¨ HTTPï¼Œå®¢æˆ·ç«¯éœ€è¦ç»´æŠ¤ä¸¤ç§è¿æ¥
3. **æƒé™ç®¡ç†**ï¼šWebSocket è¿æ¥å»ºç«‹æ—¶å°±éªŒè¯æƒé™ï¼Œåç»­æ‰€æœ‰æ–¹æ³•è‡ªåŠ¨ç»§æ‰¿
4. **ä¼šè¯ä¿æŒ**ï¼šå®¢æˆ·ç«¯è¿æ¥åï¼Œæ‰€æœ‰è¯·æ±‚éƒ½åœ¨åŒä¸€ä¸ªä¼šè¯ä¸­

**å®é™…ä¸Šï¼Œè¿™äº›ç®€å•æ–¹æ³•ä¹Ÿèƒ½ç”¨ HTTP**ï¼š

```python
# æŠ€æœ¯ä¸Šå¯è¡Œï¼Œä½†ä¸å®ç”¨
GET  /api/config          # è·å–é…ç½®
GET  /api/channels/status # æŸ¥çœ‹ channels
GET  /api/sessions        # åˆ—å‡º sessions

# ä½†æ˜¯ agent æ–¹æ³•å¿…é¡»ç”¨ WebSocket
WS   ws://localhost:8765  # Agent è°ƒç”¨

# âŒ é—®é¢˜ï¼šå®¢æˆ·ç«¯éœ€è¦ç»´æŠ¤ä¸¤ç§è¿æ¥
# âœ… è§£å†³ï¼šå…¨éƒ¨ç”¨ WebSocketï¼Œç»Ÿä¸€ç®¡ç†
```

### WebSocket çš„é¢å¤–å¥½å¤„

å³ä½¿æ˜¯ç®€å•æ–¹æ³•ï¼ŒWebSocket ä¹Ÿæœ‰ä¼˜åŠ¿ï¼š

```python
# HTTP æ–¹æ¡ˆï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦å»ºç«‹è¿æ¥
for i in range(100):
    response = await http.get("/api/config")  # âŒ 100 æ¬¡ TCP æ¡æ‰‹

# WebSocket æ–¹æ¡ˆï¼šä¸€æ¬¡è¿æ¥ï¼Œå¤šæ¬¡è¯·æ±‚
ws = await websocket.connect("ws://localhost:8765")
for i in range(100):
    await ws.send({"method": "config.get"})  # âœ… å¤ç”¨è¿æ¥
```

---

## æ€»ç»“

### ä¸ºä»€ä¹ˆ Gateway å¿…é¡»ç”¨ WebSocketï¼Ÿ

| éœ€æ±‚ | HTTP èƒ½åšåˆ°å—ï¼Ÿ | WebSocket |
|------|----------------|-----------|
| Agent æµå¼è¾“å‡º | âŒ å¦ï¼ˆå¿…é¡»ç­‰å®Œæ•´å“åº”ï¼‰ | âœ… å®æ—¶æ¨é€æ¯ä¸ª token |
| å®æ—¶äº‹ä»¶å¹¿æ’­ | âŒ å¦ï¼ˆéœ€è¦è½®è¯¢ï¼‰ | âœ… æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ |
| åŒå‘é€šä¿¡ï¼ˆä¸­æ­¢ä»»åŠ¡ï¼‰ | âŒ éš¾ï¼ˆè¯·æ±‚å‘å‡ºåæ— æ³•å–æ¶ˆï¼‰ | âœ… éšæ—¶å‘é€æ–°æ¶ˆæ¯ |
| é•¿æ—¶é—´è¿è¡Œï¼ˆ30ç§’+ï¼‰ | âš ï¸ å¯ä»¥ä½†å®¹æ˜“è¶…æ—¶ | âœ… æŒä¹…è¿æ¥ |
| å¤šä¸ªå®¢æˆ·ç«¯åŒæ­¥çŠ¶æ€ | âŒ éœ€è¦é¢‘ç¹è½®è¯¢ | âœ… å¹¿æ’­æœºåˆ¶ |
| ç»Ÿä¸€æ¥å£ | âš ï¸ éœ€è¦æ··åˆ HTTP+è½®è¯¢ | âœ… å•ä¸€ WebSocket è¿æ¥ |

### å…³é”®ç†è§£

**ä¸æ˜¯å› ä¸º"ç³»ç»Ÿç®¡ç†åŠŸèƒ½"éœ€è¦ WebSocket**ï¼Œè€Œæ˜¯å› ä¸ºï¼š

1. **Agent çš„ç‰¹æ€§ï¼ˆæµå¼è¾“å‡ºã€é•¿æ—¶é—´è¿è¡Œï¼‰å¿…é¡»ç”¨ WebSocket**
2. **Gateway ä¸ºäº†ç»Ÿä¸€æ¥å£ï¼ŒæŠŠæ‰€æœ‰æ–¹æ³•éƒ½æ”¾åœ¨ WebSocket ä¸Š**
3. **è¿™æ ·å®¢æˆ·ç«¯åªéœ€ç»´æŠ¤ä¸€ä¸ªè¿æ¥ï¼Œæ—¢èƒ½è°ƒç”¨ Agentï¼Œåˆèƒ½ç®¡ç†ç³»ç»Ÿ**

### ç±»æ¯”

```
ä¼ ç»Ÿ Web æœåŠ¡ï¼š
  â”œâ”€ API æœåŠ¡å™¨ï¼ˆHTTP RESTï¼‰      â† é€‚åˆç®€å•è¯·æ±‚-å“åº”
  â””â”€ ç”¨æˆ·ç•Œé¢ï¼ˆHTTP + è½®è¯¢ï¼‰      â† æ•ˆç‡ä½

OpenClaw Gatewayï¼š
  â””â”€ WebSocket ç»Ÿä¸€ç«¯ç‚¹
      â”œâ”€ Agent æµå¼è¾“å‡º           â† å¿…é¡» WebSocket
      â”œâ”€ å®æ—¶äº‹ä»¶å¹¿æ’­             â† å¿…é¡» WebSocket
      â””â”€ ç³»ç»Ÿç®¡ç†æ–¹æ³•             â† é¡ºä¾¿ä¹Ÿç”¨ WebSocketï¼ˆç»Ÿä¸€æ¥å£ï¼‰
```

---

## ä»£ç è¯æ®

### Control UI çš„å®ç°

```typescript
// openclaw/ui/src/ui/gateway.ts

export class GatewayClient {
  private ws: WebSocket;
  
  constructor(url: string) {
    // å»ºç«‹ WebSocket è¿æ¥
    this.ws = new WebSocket(url);
    
    // ç›‘å¬æ‰€æœ‰äº‹ä»¶
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      // å¤„ç† Agent äº‹ä»¶ï¼ˆæµå¼è¾“å‡ºï¼‰
      if (data.type === "text") {
        this.onAgentText(data.text);  // é€å­—æ˜¾ç¤º
      }
      
      // å¤„ç†å¹¿æ’­äº‹ä»¶ï¼ˆå…¶ä»– channel çš„æ¶ˆæ¯ï¼‰
      if (data.event === "chat") {
        this.onChatEvent(data);  // å®æ—¶æ›´æ–°èŠå¤©åˆ—è¡¨
      }
    };
  }
  
  // è°ƒç”¨ Agentï¼ˆæµå¼ï¼‰
  async callAgent(message: string) {
    await this.ws.send(JSON.stringify({
      method: "agent",
      params: { message }
    }));
    // å“åº”ä¼šé€šè¿‡ onmessage å›è°ƒå®æ—¶æ¥æ”¶
  }
  
  // è·å–é…ç½®ï¼ˆè™½ç„¶ç®€å•ï¼Œä½†ä¹Ÿç”¨ WebSocketï¼‰
  async getConfig(): Promise<Config> {
    const id = generateId();
    
    await this.ws.send(JSON.stringify({
      id,  // è¯·æ±‚ ID
      method: "config.get",
      params: {}
    }));
    
    // ç­‰å¾…å“åº”ï¼ˆä¹Ÿæ˜¯é€šè¿‡ WebSocketï¼‰
    return new Promise((resolve) => {
      this.pendingRequests[id] = resolve;
    });
  }
}
```

**å…³é”®ç‚¹**ï¼š
- æ‰€æœ‰æ–¹æ³•ï¼ˆagentã€config.get ç­‰ï¼‰éƒ½ç”¨åŒä¸€ä¸ª WebSocket è¿æ¥
- Agent çš„å“åº”æ˜¯æµå¼çš„ï¼ˆå¤šæ¬¡ onmessageï¼‰
- é…ç½®è·å–æ˜¯å•æ¬¡å“åº”ï¼Œä½†ä¹Ÿç”¨ WebSocketï¼ˆç»Ÿä¸€æ¥å£ï¼‰

---

**æ€»ç»“ä¸€å¥è¯**ï¼šGateway ç”¨ WebSocket ä¸æ˜¯å› ä¸º"è°ƒç”¨ç³»ç»ŸåŠŸèƒ½"éœ€è¦ï¼Œè€Œæ˜¯å› ä¸º **Agent çš„æµå¼è¾“å‡ºå’Œå®æ—¶äº‹ä»¶å¹¿æ’­** å¿…é¡»ç”¨ WebSocketï¼Œé¡ºä¾¿æŠŠæ‰€æœ‰ç®¡ç†æ–¹æ³•ä¹Ÿç»Ÿä¸€åˆ° WebSocket ä¸Šï¼Œç®€åŒ–å®¢æˆ·ç«¯å®ç°ã€‚
